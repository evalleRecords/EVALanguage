<script>
const status = document.getElementById('status');
const player = document.getElementById('player');
const validSpeakers = ["mari","taavi","anna","martin"];

async function callTTS(text, speaker) {
  const resp = await fetch("/api/tts", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text, speaker, speed: 1 })
  });

  if (!resp.ok) {
    throw new Error(await resp.text());
  }

  return await resp.blob();
}

document.getElementById('speak').addEventListener('click', async () => {
  status.textContent = "Working...";
  player.src = "";

  try {
    // Get text and speaker
    let text = document.getElementById('text').value.trim();
    let speaker = document.getElementById('speaker').value.trim();

    // Validate speaker
    if (!validSpeakers.includes(speaker)) {
      status.textContent = "Invalid speaker, using default 'mari'";
      speaker = "mari";
    }

    // Validate text
    if (!text) throw new Error("Please enter text");
    text = text.substring(0, 200); // truncate to 200 chars max

    // Call TTS
    const audioBlob = await callTTS(text, speaker);
    const url = URL.createObjectURL(audioBlob);
    player.src = url;
    player.play();

    status.textContent = "Playing audio...";
  } catch (err) {
    console.error(err);
    status.textContent = "Error: " + err.message;
  }
});
</script>
